<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中药识别 - 枸杞与菊花</title>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.1/lib/p5.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.1/lib/addons/p5.dom.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.19.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-tflite@0.0.1-alpha.12/dist/tf-tflite.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            text-align: center;
        }
        #video-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        video, canvas {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 15px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        #result {
            font-size: 24px;
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background-color: white;
            display: inline-block;
        }
        .probability {
            font-size: 18px;
            margin: 5px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>中药识别</h1>
    <p>拍照识别药材是枸杞还是菊花</p>
    
    <div id="video-container">
        <video id="webcam" autoplay playsinline style="display: none;"></video>
        <canvas id="canvas" style="display: none;"></canvas>
        <div id="placeholder" style="padding: 100px 0; background-color: #ddd; border-radius: 10px;">
            点击"开启相机"开始
        </div>
    </div>
    
    <div>
        <button id="startBtn">开启相机</button>
        <button id="captureBtn" disabled>拍照识别</button>
        <button id="resetBtn" disabled>重新拍摄</button>
    </div>
    
    <div id="result">等待识别...</div>
    <div id="probabilities"></div>

    <script>
        let model;
        let webcam;
        let canvas, ctx;
        let isModelLoaded = false;
        let isWebcamActive = false;

        // DOM元素
        const startBtn = document.getElementById('startBtn');
        const captureBtn = document.getElementById('captureBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultDiv = document.getElementById('result');
        const probabilitiesDiv = document.getElementById('probabilities');
        const videoContainer = document.getElementById('video-container');
        const placeholder = document.getElementById('placeholder');
        const webcamElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('canvas');

        // 加载模型
        async function loadModel() {
            try {
                // 请将此处替换为您从Teachable Machine导出的模型URL
                model = await tf.tflite.loadTFLiteModel('model.tflite');
                isModelLoaded = true;
                console.log('模型加载成功');
            } catch (err) {
                console.error('模型加载失败:', err);
                resultDiv.textContent = '模型加载失败，请重试';
            }
        }

        // 启动相机
        async function startWebcam() {
            if (!isModelLoaded) {
                resultDiv.textContent = '模型加载中，请稍候...';
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment', // 优先使用后置摄像头
                        width: { ideal: 400 },
                        height: { ideal: 400 }
                    } 
                });
                
                webcamElement.srcObject = stream;
                webcam = webcamElement;
                
                canvasElement.width = 400;
                canvasElement.height = 400;
                canvas = canvasElement;
                ctx = canvas.getContext('2d');
                
                // 显示相机画面，隐藏占位符
                placeholder.style.display = 'none';
                webcamElement.style.display = 'block';
                canvasElement.style.display = 'none';
                
                isWebcamActive = true;
                startBtn.disabled = true;
                captureBtn.disabled = false;
                resetBtn.disabled = false;
                resultDiv.textContent = '请点击拍照识别';
            } catch (err) {
                console.error('相机启动失败:', err);
                resultDiv.textContent = '相机启动失败，请检查权限';
            }
        }

        // 拍照并识别
        function captureAndClassify() {
            if (!isWebcamActive || !isModelLoaded) return;
            
            // 从摄像头捕获图像到画布
            ctx.drawImage(webcam, 0, 0, canvas.width, canvas.height);
            
            // 显示画布，隐藏摄像头画面
            webcamElement.style.display = 'none';
            canvasElement.style.display = 'block';
            
            // 准备图像数据进行分类
            classifyImage();
        }

        // 图像分类
        async function classifyImage() {
            if (!model || !canvas) return;
            
            try {
                // 预处理图像
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                let tensor = tf.browser.fromPixels(imageData)
                    .resizeBilinear([224, 224]) // 调整为模型输入尺寸
                    .toFloat()
                    .div(tf.scalar(255)) // 归一化
                    .expandDims();
                
                // 进行预测
                const predictions = model.predict(tensor);
                const result = await predictions.data();
                
                // 处理结果 (假设0:枸杞, 1:菊花)
                const classes = ['枸杞', '菊花'];
                const枸杞概率 = (result[0] * 100).toFixed(1);
                const菊花概率 = (result[1] * 100).toFixed(1);
                
                // 显示结果
                let predictedClass =枸杞概率 > 菊花概率 ? '枸杞' : '菊花';
                let confidence =枸杞概率 > 菊花概率 ? 枸杞概率 : 菊花概率;
                
                resultDiv.textContent = `可能是: ${predictedClass} (${confidence}%)`;
                probabilitiesDiv.innerHTML = `
                    <div class="probability">枸杞: ${枸杞概率}%</div>
                    <div class="probability">菊花: ${菊花概率}%</div>
                `;
                
                // 清理张量
                tensor.dispose();
                predictions.dispose();
            } catch (err) {
                console.error('识别失败:', err);
                resultDiv.textContent = '识别失败，请重试';
            }
        }

        // 重置相机
        function resetCamera() {
            if (isWebcamActive) {
                webcamElement.style.display = 'block';
                canvasElement.style.display = 'none';
                resultDiv.textContent = '请点击拍照识别';
                probabilitiesDiv.innerHTML = '';
            }
        }

        // 事件监听
        startBtn.addEventListener('click', startWebcam);
        captureBtn.addEventListener('click', captureAndClassify);
        resetBtn.addEventListener('click', resetCamera);

        // 页面加载时加载模型
        window.addEventListener('load', loadModel);
    </script>
</body>
</html>