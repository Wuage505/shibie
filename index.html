<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>中药识别 - 枸杞/菊花</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入TensorFlow.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .media-container {
            position: relative;
            width: 100%;
            padding-top: 133%; /* 4:3比例 */
            overflow: hidden;
            border-radius: 16px;
            background-color: #000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #webcam, #uploaded-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #uploaded-image {
            display: none; /* 默认隐藏上传的图片 */
        }
        .btn {
            transition: all 0.2s ease;
        }
        .btn:active {
            transform: scale(0.95);
        }
        .result-card {
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .result-card.show {
            transform: translateY(0);
            opacity: 1;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* 隐藏文件输入框的默认样式 */
        #image-upload {
            display: none;
        }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">
    <!-- 标题区域 -->
    <div class="text-center mb-6">
        <h1 class="text-[clamp(1.5rem,5vw,2rem)] font-bold text-green-700">
            <i class="fa fa-leaf mr-2"></i>中药识别
        </h1>
        <p class="text-gray-500 text-sm">支持拍照或上传图片识别枸杞/菊花</p>
    </div>

    <!-- 媒体展示区域（相机/上传图片） -->
    <div class="media-container mb-6">
        <video id="webcam" autoplay muted playsinline style="display: none;"></video>
        <img id="uploaded-image" alt="上传的图片">
        <!-- 初始提示 -->
        <div id="media-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-white">
            <i class="fa fa-camera text-5xl mb-3 opacity-70"></i>
            <p class="text-sm opacity-70">点击下方按钮选择识别方式</p>
        </div>
    </div>

    <!-- 控制按钮 -->
    <div class="flex flex-wrap justify-center gap-3 mb-6">
        <button id="start-cam-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white px-5 py-3 rounded-full flex items-center shadow-md">
            <i class="fa fa-video-camera mr-2"></i> 相机识别
        </button>
        <label for="image-upload" class="btn bg-purple-500 hover:bg-purple-600 text-white px-5 py-3 rounded-full flex items-center shadow-md cursor-pointer">
            <i class="fa fa-upload mr-2"></i> 上传图片
        </label>
        <input type="file" id="image-upload" accept="image/*">
        <button id="identify-btn" class="btn bg-green-500 hover:bg-green-600 text-white px-5 py-3 rounded-full flex items-center shadow-md" disabled>
            <i class="fa fa-search mr-2"></i> 开始识别
        </button>
    </div>

    <!-- 结果展示区域 -->
    <div id="result-card" class="result-card bg-white rounded-xl shadow-md p-5 mb-6">
        <h2 class="text-xl font-semibold text-center mb-4">识别结果</h2>
        <div class="text-center mb-4">
            <p id="prediction" class="text-[clamp(1.5rem,5vw,2rem)] font-bold text-purple-600">--</p>
            <p id="confidence" class="text-gray-500">可信度：--%</p>
        </div>
        <!-- 概率分布 -->
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-sm text-gray-500">枸杞</p>
                <p id="wolfberry" class="font-bold text-red-500">--%</p>
            </div>
            <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-sm text-gray-500">菊花</p>
                <p id="chrysanthemum" class="font-bold text-yellow-500">--%</p>
            </div>
        </div>
        <!-- 重新识别按钮 -->
        <button id="reset-btn" class="mt-4 w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg">
            重新识别
        </button>
    </div>

    <!-- 状态提示 -->
    <div id="status" class="text-center text-gray-500 text-sm py-2">
        <i class="fa fa-circle-o-notch fa-spin mr-1 loading-spinner"></i> 加载模型中...
    </div>

    <script>
        // 模型处理核心类
        class HerbModelHandler {
            constructor(modelUrl = 'model/model.json', classNames = ['枸杞', '菊花']) {
                this.modelUrl = modelUrl;
                this.classNames = classNames;
                this.model = null;
                this.isLoaded = false;
            }

            // 加载模型
            async loadModel() {
                try {
                    if (this.isLoaded) return true;
                    this.model = await tf.loadLayersModel(this.modelUrl);
                    this.isLoaded = true;
                    console.log('模型加载成功');
                    return true;
                } catch (error) {
                    console.error('模型加载失败：', error);
                    this.isLoaded = false;
                    return false;
                }
            }

            // 图像预处理
            preprocessImage(imgTensor) {
                return tf.tidy(() => {
                    return imgTensor.resizeBilinear([224, 224]) // 与训练时输入尺寸一致
                        .toFloat()
                        .div(255.0) // 归一化到0-1
                        .expandDims(0); // 添加批次维度
                });
            }

            // 执行推理
            async predict(imgTensor) {
                if (!this.isLoaded || !this.model) {
                    console.error('模型未加载');
                    return null;
                }

                try {
                    const processedImg = this.preprocessImage(imgTensor);
                    const predictions = await this.model.predict(processedImg).data();
                    const scores = Array.from(predictions);

                    const maxScore = Math.max(...scores);
                    const predictedIndex = scores.indexOf(maxScore);
                    
                    const result = {
                        predictedClass: this.classNames[predictedIndex],
                        confidence: (maxScore * 100).toFixed(1),
                        probabilities: {
                            [this.classNames[0]]: (scores[0] * 100).toFixed(1),
                            [this.classNames[1]]: (scores[1] * 100).toFixed(1)
                        }
                    };

                    tf.dispose([imgTensor, processedImg]); // 清理内存
                    return result;
                } catch (error) {
                    console.error('推理失败：', error);
                    return null;
                }
            }
        }

        // 全局变量
        const modelHandler = new HerbModelHandler();
        let webcam = null;
        let currentMode = null; // 'camera' 或 'upload'

        // DOM元素
        const startCamBtn = document.getElementById('start-cam-btn');
        const imageUpload = document.getElementById('image-upload');
        const identifyBtn = document.getElementById('identify-btn');
        const resetBtn = document.getElementById('reset-btn');
        const webcamElement = document.getElementById('webcam');
        const uploadedImage = document.getElementById('uploaded-image');
        const mediaPlaceholder = document.getElementById('media-placeholder');
        const resultCard = document.getElementById('result-card');
        const predictionElement = document.getElementById('prediction');
        const confidenceElement = document.getElementById('confidence');
        const wolfberryElement = document.getElementById('wolfberry');
        const chrysanthemumElement = document.getElementById('chrysanthemum');
        const statusElement = document.getElementById('status');

        // 页面加载完成后初始化模型
        window.onload = async () => {
            const loadSuccess = await modelHandler.loadModel();
            if (loadSuccess) {
                statusElement.textContent = '模型加载完成，请选择识别方式';
                startCamBtn.disabled = false;
                imageUpload.disabled = false;
            } else {
                statusElement.innerHTML = `<span class="text-red-500"><i class="fa fa-exclamation-circle mr-1"></i>模型加载失败：请检查model文件夹</span>`;
            }
        };

        // 相机识别模式
        startCamBtn.addEventListener('click', async () => {
            try {
                statusElement.textContent = '正在打开相机...';
                currentMode = 'camera';
                
                // 隐藏其他元素，显示相机
                uploadedImage.style.display = 'none';
                mediaPlaceholder.classList.add('hidden');
                webcamElement.style.display = 'block';

                // 请求后置摄像头
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 480 },
                        height: { ideal: 640 }
                    }
                });

                webcamElement.srcObject = stream;
                webcam = await tf.data.webcam(webcamElement);
                
                // 启用识别按钮
                identifyBtn.disabled = false;
                statusElement.textContent = '请对准药材，点击开始识别';
            } catch (error) {
                statusElement.innerHTML = `<span class="text-red-500"><i class="fa fa-exclamation-circle mr-1"></i>相机打开失败：请允许权限</span>`;
                console.error('相机错误：', error);
            }
        });

        // 上传图片识别模式
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            currentMode = 'upload';
            // 隐藏其他元素，显示上传的图片
            webcamElement.style.display = 'none';
            mediaPlaceholder.classList.add('hidden');
            uploadedImage.style.display = 'block';

            // 预览上传的图片
            const reader = new FileReader();
            reader.onload = (event) => {
                uploadedImage.src = event.target.result;
                // 图片加载完成后启用识别按钮
                uploadedImage.onload = () => {
                    identifyBtn.disabled = false;
                    statusElement.textContent = '图片已上传，点击开始识别';
                };
            };
            reader.readAsDataURL(file);
        });

        // 开始识别
        identifyBtn.addEventListener('click', async () => {
            if (!modelHandler.isLoaded) return;

            statusElement.textContent = '识别中...';
            identifyBtn.disabled = true;

            try {
                let imgTensor;

                // 根据当前模式获取图像张量
                if (currentMode === 'camera' && webcam) {
                    // 从相机捕获图像
                    const img = await webcam.capture();
                    imgTensor = img;
                } else if (currentMode === 'upload' && uploadedImage.src) {
                    // 从上传的图片创建张量
                    imgTensor = tf.browser.fromPixels(uploadedImage);
                } else {
                    throw new Error('未获取到图像，请重试');
                }

                // 模型推理
                const result = await modelHandler.predict(imgTensor);

                if (result) {
                    // 显示结果
                    predictionElement.textContent = result.predictedClass;
                    confidenceElement.textContent = `可信度：${result.confidence}%`;
                    wolfberryElement.textContent = `${result.probabilities.枸杞}%`;
                    chrysanthemumElement.textContent = `${result.probabilities.菊花}%`;
                    resultCard.classList.add('show');
                    statusElement.textContent = '识别完成';
                } else {
                    throw new Error('无法获取识别结果');
                }
            } catch (error) {
                statusElement.innerHTML = `<span class="text-red-500"><i class="fa fa-exclamation-circle mr-1"></i>识别失败：${error.message}</span>`;
                identifyBtn.disabled = false;
            }
        });

        // 重新识别（重置状态）
        resetBtn.addEventListener('click', () => {
            // 隐藏结果卡片
            resultCard.classList.remove('show');
            // 重置媒体区域
            webcamElement.style.display = 'none';
            uploadedImage.style.display = 'none';
            mediaPlaceholder.classList.remove('hidden');
            // 停止相机流（如果在相机模式）
            if (currentMode === 'camera' && webcamElement.srcObject) {
                webcamElement.srcObject.getTracks().forEach(track => track.stop());
                webcam = null;
            }
            // 重置文件输入
            imageUpload.value = '';
            // 重置状态
            currentMode = null;
            identifyBtn.disabled = true;
            statusElement.textContent = '请选择识别方式（相机/上传图片）';
        });
    </script>
</body>
</html>
