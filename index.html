<!DOCTYPE html>
<html>
<head>
    <title>中药识别 - JavaScript实现</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { text-align: center; }
        #uploadArea { border: 2px dashed #ccc; padding: 40px 20px; margin: 20px 0; cursor: pointer; }
        #uploadArea:hover { border-color: #666; }
        #preview { max-width: 100%; margin: 20px 0; display: none; }
        #result { margin: 20px 0; padding: 20px; border-radius: 8px; display: none; }
        .status { color: #666; margin: 10px 0; }
        .probability { margin: 10px 0; }
    </style>
    <!-- 引入TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>中药识别（枸杞/菊花）</h1>
        <div class="status" id="status">准备加载模型...</div>
        
        <div id="uploadArea">
            <p>点击或拖拽图片到此处上传</p>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
        </div>
        
        <img id="preview" alt="预览图片">
        
        <button id="predictBtn" disabled>开始识别</button>
        
        <div id="result">
            <h3>识别结果: <span id="prediction"></span></h3>
            <div class="probability">枸杞概率: <span id="wolfberry"></span></div>
            <div class="probability">菊花概率: <span id="chrysanthemum"></span></div>
        </div>
    </div>

    <script>
        // 全局变量
        let model;
        const CLASS_NAMES = ['枸杞', '菊花']; // 识别类别
        const MODEL_URL = 'https://wuage505.github.io/shibie/model.json'; // 模型地址
        const WEIGHTS_URL = 'https://wuage505.github.io/shibie/weights.bin'; // 权重地址

        // DOM元素
        const statusElement = document.getElementById('status');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const previewImage = document.getElementById('preview');
        const predictBtn = document.getElementById('predictBtn');
        const resultElement = document.getElementById('result');
        const predictionElement = document.getElementById('prediction');
        const wolfberryElement = document.getElementById('wolfberry');
        const chrysanthemumElement = document.getElementById('chrysanthemum');

        // 初始化函数
        async function init() {
            try {
                // 检查模型文件是否存在
                statusElement.textContent = '检查模型文件...';
                await checkModelFiles();

                // 加载模型
                statusElement.textContent = '加载模型中...';
                model = await loadModel();

                // 模型加载成功
                statusElement.textContent = '模型加载完成，可上传图片';
                predictBtn.disabled = false;

            } catch (error) {
                statusElement.textContent = `错误: ${error.message}`;
                console.error('初始化失败:', error);
            }
        }

        // 检查模型文件是否可访问
        async function checkModelFiles() {
            // 检查model.json
            const modelResponse = await fetch(MODEL_URL);
            if (!modelResponse.ok) {
                throw new Error(`模型文件不存在 (${MODEL_URL})`);
            }

            // 检查weights.bin
            const weightsResponse = await fetch(WEIGHTS_URL);
            if (!weightsResponse.ok) {
                throw new Error(`权重文件不存在 (${WEIGHTS_URL})`);
            }
        }

        // 加载模型
        async function loadModel() {
            return await tf.loadLayersModel({
                modelTopology: await (await fetch(MODEL_URL)).json(),
                weightManifestUrl: WEIGHTS_URL
            });
        }

        // 处理图片上传
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 显示预览
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
                resultElement.style.display = 'none'; // 隐藏之前的结果
            };
            reader.readAsDataURL(file);
        }

        // 图像预处理（适配模型输入）
        function preprocessImage(image) {
            return tf.tidy(() => {
                // 将图像转换为张量
                let tensor = tf.browser.fromPixels(image)
                    .resizeBilinear([224, 224]) // 调整尺寸为模型输入大小
                    .toFloat()
                    .div(tf.scalar(255.0)) // 归一化到0-1范围
                    .expandDims(); // 添加批次维度
                return tensor;
            });
        }

        // 预测函数
        async function predict() {
            if (!model || !previewImage.src) return;

            statusElement.textContent = '识别中...';
            predictBtn.disabled = true;

            try {
                // 预处理图像
                const tensor = preprocessImage(previewImage);

                // 模型预测
                const predictions = await model.predict(tensor).data();

                // 解析结果
                const scores = Array.from(predictions);
                const maxScore = Math.max(...scores);
                const predictedClass = CLASS_NAMES[scores.indexOf(maxScore)];

                // 显示结果
                predictionElement.textContent = predictedClass;
                wolfberryElement.textContent = `${(scores[0] * 100).toFixed(2)}%`;
                chrysanthemumElement.textContent = `${(scores[1] * 100).toFixed(2)}%`;
                resultElement.style.display = 'block';

                statusElement.textContent = '识别完成';

            } catch (error) {
                statusElement.textContent = `识别失败: ${error.message}`;
                console.error('预测错误:', error);
            } finally {
                predictBtn.disabled = false;
                tf.disposeVariables(); // 清理内存
            }
        }

        // 事件监听
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);
        predictBtn.addEventListener('click', predict);

        // 拖放功能
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#666';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#ccc';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileUpload({ target: fileInput });
            }
        });

        // 页面加载完成后初始化
        window.onload = init;
    </script>
</body>
</html>
