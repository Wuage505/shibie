<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>中药识别 - 枸杞/菊花</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入TensorFlow.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
    <style>
        body {
            background-color: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        .camera-container {
            position: relative;
            width: 100%;
            padding-top: 133%; /* 4:3比例，适配手机屏幕 */
            overflow: hidden;
            border-radius: 16px;
            background-color: #000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #webcam {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .btn {
            transition: all 0.2s ease;
        }
        .btn:active {
            transform: scale(0.95);
        }
        .result-card {
            transform: translateY(20px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        .result-card.show {
            transform: translateY(0);
            opacity: 1;
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">
    <!-- 标题区域 -->
    <div class="text-center mb-6">
        <h1 class="text-[clamp(1.5rem,5vw,2rem)] font-bold text-green-700">
            <i class="fa fa-leaf mr-2"></i>中药识别
        </h1>
        <p class="text-gray-500 text-sm">拍照识别枸杞或菊花</p>
    </div>

    <!-- 相机区域 -->
    <div class="camera-container mb-6">
        <video id="webcam" autoplay muted playsinline></video>
        <!-- 相机未打开时的提示 -->
        <div id="camera-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-white">
            <i class="fa fa-camera text-5xl mb-3 opacity-70"></i>
            <p class="text-sm opacity-70">点击下方按钮打开相机</p>
        </div>
    </div>

    <!-- 控制按钮 -->
    <div class="flex justify-center gap-4 mb-8">
        <button id="start-btn" class="btn bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-full flex items-center shadow-md">
            <i class="fa fa-video-camera mr-2"></i> 打开相机
        </button>
        <button id="capture-btn" class="btn bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-full flex items-center shadow-md" disabled>
            <i class="fa fa-camera mr-2"></i> 识别
        </button>
    </div>

    <!-- 结果展示区域 -->
    <div id="result-card" class="result-card bg-white rounded-xl shadow-md p-5 mb-6">
        <h2 class="text-xl font-semibold text-center mb-4">识别结果</h2>
        <div class="text-center mb-4">
            <p id="prediction" class="text-[clamp(1.5rem,5vw,2rem)] font-bold text-purple-600">--</p>
            <p id="confidence" class="text-gray-500">可信度：--%</p>
        </div>
        <!-- 概率分布 -->
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-sm text-gray-500">枸杞</p>
                <p id="wolfberry" class="font-bold text-red-500">--%</p>
            </div>
            <div class="bg-gray-50 p-3 rounded-lg">
                <p class="text-sm text-gray-500">菊花</p>
                <p id="chrysanthemum" class="font-bold text-yellow-500">--%</p>
            </div>
        </div>
        <!-- 重新识别按钮 -->
        <button id="reset-btn" class="mt-4 w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg">
            重新识别
        </button>
    </div>

    <!-- 状态提示 -->
    <div id="status" class="text-center text-gray-500 text-sm py-2">
        <i class="fa fa-circle-o-notch fa-spin mr-1 loading-spinner"></i> 加载模型中...
    </div>

    <script>
        // 模型处理核心类（重点：修改模型路径为model文件夹下的model.json）
        class HerbModelHandler {
            // 模型路径改为 'model/model.json'（因为模型在model子文件夹中）
            constructor(modelUrl = 'model/model.json', classNames = ['枸杞', '菊花']) {
                this.modelUrl = modelUrl;
                this.classNames = classNames;
                this.model = null;
                this.isLoaded = false;
            }

            // 加载模型
            async loadModel() {
                try {
                    if (this.isLoaded) return true;
                    this.model = await tf.loadLayersModel(this.modelUrl);
                    this.isLoaded = true;
                    console.log('模型加载成功');
                    return true;
                } catch (error) {
                    console.error('模型加载失败：', error);
                    this.isLoaded = false;
                    return false;
                }
            }

            // 图像预处理
            preprocessImage(imgTensor) {
                return tf.tidy(() => {
                    return imgTensor.resizeBilinear([224, 224]) // 与训练时输入尺寸一致
                        .toFloat()
                        .div(255.0) // 归一化到0-1
                        .expandDims(0); // 添加批次维度
                });
            }

            // 执行推理
            async predict(imgTensor) {
                if (!this.isLoaded || !this.model) {
                    console.error('模型未加载');
                    return null;
                }

                try {
                    const processedImg = this.preprocessImage(imgTensor);
                    const predictions = await this.model.predict(processedImg).data();
                    const scores = Array.from(predictions);

                    const maxScore = Math.max(...scores);
                    const predictedIndex = scores.indexOf(maxScore);
                    
                    const result = {
                        predictedClass: this.classNames[predictedIndex],
                        confidence: (maxScore * 100).toFixed(1),
                        probabilities: {
                            [this.classNames[0]]: (scores[0] * 100).toFixed(1),
                            [this.classNames[1]]: (scores[1] * 100).toFixed(1)
                        }
                    };

                    tf.dispose([imgTensor, processedImg]); // 清理内存
                    return result;
                } catch (error) {
                    console.error('推理失败：', error);
                    return null;
                }
            }
        }

        // 初始化模型（自动使用model/model.json路径）
        const modelHandler = new HerbModelHandler();
        let webcam; // 相机实例

        // DOM元素
        const startBtn = document.getElementById('start-btn');
        const captureBtn = document.getElementById('capture-btn');
        const resetBtn = document.getElementById('reset-btn');
        const webcamElement = document.getElementById('webcam');
        const cameraPlaceholder = document.getElementById('camera-placeholder');
        const resultCard = document.getElementById('result-card');
        const predictionElement = document.getElementById('prediction');
        const confidenceElement = document.getElementById('confidence');
        const wolfberryElement = document.getElementById('wolfberry');
        const chrysanthemumElement = document.getElementById('chrysanthemum');
        const statusElement = document.getElementById('status');

        // 页面加载完成后初始化
        window.onload = async () => {
            const loadSuccess = await modelHandler.loadModel();
            if (loadSuccess) {
                statusElement.textContent = '模型加载完成，点击打开相机';
                startBtn.disabled = false;
            } else {
                statusElement.innerHTML = `<span class="text-red-500"><i class="fa fa-exclamation-circle mr-1"></i>模型加载失败：请检查model文件夹中的文件</span>`;
            }
        };

        // 打开相机
        startBtn.addEventListener('click', async () => {
            try {
                statusElement.textContent = '正在打开相机...';
                // 请求后置摄像头
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 480 },
                        height: { ideal: 640 }
                    }
                });

                webcamElement.srcObject = stream;
                cameraPlaceholder.classList.add('hidden');
                webcam = await tf.data.webcam(webcamElement);

                captureBtn.disabled = false;
                statusElement.textContent = '请对准药材，点击识别按钮';
            } catch (error) {
                statusElement.innerHTML = `<span class="text-red-500"><i class="fa fa-exclamation-circle mr-1"></i>相机打开失败：请允许相机权限</span>`;
                console.error('相机错误：', error);
            }
        });

        // 拍照识别
        captureBtn.addEventListener('click', async () => {
            if (!webcam) return;

            statusElement.textContent = '识别中...';
            captureBtn.disabled = true;

            try {
                const img = await webcam.capture(); // 捕获图像
                const result = await modelHandler.predict(img); // 模型推理

                if (result) {
                    // 显示结果
                    predictionElement.textContent = result.predictedClass;
                    confidenceElement.textContent = `可信度：${result.confidence}%`;
                    wolfberryElement.textContent = `${result.probabilities.枸杞}%`;
                    chrysanthemumElement.textContent = `${result.probabilities.菊花}%`;
                    resultCard.classList.add('show');
                    statusElement.textContent = '识别完成';
                } else {
                    statusElement.innerHTML = `<span class="text-red-500"><i class="fa fa-exclamation-circle mr-1"></i>识别失败，请重试</span>`;
                    captureBtn.disabled = false;
                }
            } catch (error) {
                statusElement.innerHTML = `<span class="text-red-500"><i class="fa fa-exclamation-circle mr-1"></i>操作失败：${error.message}</span>`;
                captureBtn.disabled = false;
            }
        });

        // 重新识别
        resetBtn.addEventListener('click', () => {
            resultCard.classList.remove('show');
            captureBtn.disabled = false;
            statusElement.textContent = '请对准药材，点击识别按钮';
        });
    </script>
</body>
</html>
